<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="UTF-8">
<title>R2D2 Interactive Scene with Meteors</title>
<style>
  body { margin: 0; overflow: hidden; }
  #info {
    position: absolute; top: 10px; left: 10px;
    z-index: 100; font-size: 20px;
    background: rgba(255,255,255,0.8); padding: 5px;
  }
</style>
</head>
<body>
<div id="info">Loading Scene...</div>

<script src="https://cdn.jsdelivr.net/npm/three@0.128.0/build/three.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/controls/OrbitControls.js"></script>
<script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/loaders/MTLLoader.js"></script>
<script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/loaders/OBJLoader.js"></script>
<script src="https://cdn.jsdelivr.net/npm/lil-gui@0.17"></script>

<script>
const scene = new THREE.Scene();
const renderer = new THREE.WebGLRenderer({ antialias: true });
renderer.setSize(window.innerWidth, window.innerHeight);
renderer.shadowMap.enabled = true;
renderer.shadowMap.type = THREE.PCFSoftShadowMap;
document.body.appendChild(renderer.domElement);

const camera = new THREE.PerspectiveCamera(75, window.innerWidth/window.innerHeight, 0.1, 1000);
camera.position.set(0, 20, 60);

const controls = new THREE.OrbitControls(camera, renderer.domElement);
controls.target.set(0, 15, 0);
controls.update();

const ambientLight = new THREE.AmbientLight(0x808080);
scene.add(ambientLight);

const dirLight = new THREE.DirectionalLight(0xffffff, 1);
dirLight.position.set(30,50,30);
dirLight.castShadow = true;
scene.add(dirLight);

// GUI
const gui = new lil.GUI();
const lightFolder = gui.addFolder('Directional Light');
lightFolder.add(dirLight.position, 'x', -50, 50);
lightFolder.add(dirLight.position, 'y', 0, 100);
lightFolder.add(dirLight.position, 'z', -50, 50);
lightFolder.open();

// Meteor settings GUI
const meteorSettings = { count:5, speed:0.2 };
const meteorFolder = gui.addFolder('Meteors');
meteorFolder.add(meteorSettings, 'count', 1, 20, 1).name("จำนวนอุกาบาต").onChange(resetMeteors);
meteorFolder.add(meteorSettings, 'speed', 0.05, 1, 0.01).name("ความเร็ว");
meteorFolder.open();

// Ground
const groundTexture = new THREE.TextureLoader().load('https://raw.githubusercontent.com/Dechachai05/model/main/grass.jpg');
groundTexture.wrapS = groundTexture.wrapT = THREE.RepeatWrapping;
groundTexture.repeat.set(1,1);
const groundMat = new THREE.MeshStandardMaterial({ map: groundTexture, roughness:0.8, metalness:0.2 });
const groundGeo = new THREE.PlaneGeometry(50,50);
const ground = new THREE.Mesh(groundGeo, groundMat);
ground.rotation.x = -Math.PI/2;
ground.receiveShadow = true;
scene.add(ground);

// 360° background
new THREE.TextureLoader().load('https://raw.githubusercontent.com/Dechachai05/model/main/background1.jpg', texture=>{
    texture.mapping = THREE.EquirectangularReflectionMapping;
    scene.background = texture;
});

// PBR textures
const texLoader = new THREE.TextureLoader();
const baseColorMap = texLoader.load('https://raw.githubusercontent.com/Dechachai05/model/main/SHD_R2R2_baseColor.jpeg');
const emissiveMap  = texLoader.load('https://raw.githubusercontent.com/Dechachai05/model/main/SHD_R2R2_emissive.jpeg');
const metallicRoughnessMap = texLoader.load('https://raw.githubusercontent.com/Dechachai05/model/main/SHD_R2R2_metallicRoughness.png');
const normalMap    = texLoader.load('https://raw.githubusercontent.com/Dechachai05/model/main/SHD_R2R2_normal.png');

let r2d2;
const mtlLoader = new THREE.MTLLoader();
mtlLoader.load('https://raw.githubusercontent.com/Dechachai05/model/main/r2d2.mtl', materials=>{
    materials.preload();
    const objLoader = new THREE.OBJLoader();
    objLoader.setMaterials(materials);
    objLoader.load('https://raw.githubusercontent.com/Dechachai05/model/main/r2d2.obj', object=>{
        object.traverse(child=>{
            if(child.isMesh){
                child.material = new THREE.MeshStandardMaterial({
                    map: baseColorMap,
                    emissiveMap: emissiveMap,
                    metalnessMap: metallicRoughnessMap,
                    roughnessMap: metallicRoughnessMap,
                    normalMap: normalMap,
                    metalness:1.0,
                    roughness:1.0,
                    emissiveIntensity:1.0
                });
                child.castShadow = true;
                child.receiveShadow = true;
            }
        });
        const bbox = new THREE.Box3().setFromObject(object);
        const maxDim = Math.max(...Object.values(bbox.getSize(new THREE.Vector3())));
        const scale = 20 / maxDim;
        object.scale.set(scale, scale, scale);
        const bboxScaled = new THREE.Box3().setFromObject(object);
        object.position.y -= bboxScaled.min.y;

        r2d2 = object;
        scene.add(object);
        document.getElementById('info').innerText = "R2D2 loaded!";
    });
});

// Buildings
const buildingGeo = new THREE.BoxGeometry(5,20,5);
const buildingMat = new THREE.MeshStandardMaterial({color:0x888888});
const buildings = [];
for(let i=-1;i<=1;i++){
    const b = new THREE.Mesh(buildingGeo, buildingMat);
    b.position.set(i*10,10,-15);
    b.castShadow=true;
    b.receiveShadow=true;
    scene.add(b);
    buildings.push(b);
}

// Meteors
let meteors = [];
function resetMeteors(){
    meteors.forEach(m=>scene.remove(m.mesh));
    meteors = [];
    for(let i=0;i<meteorSettings.count;i++){
        const m = new THREE.Mesh(new THREE.SphereGeometry(2,16,16), new THREE.MeshStandardMaterial({color:0xAA3333}));
        m.position.set(Math.random()*40-20,50 + i*15,Math.random()*40-20);
        m.castShadow=true;
        m.receiveShadow=true;
        meteors.push({mesh:m, velocity:new THREE.Vector3(0,-meteorSettings.speed,0)});
        scene.add(m);
    }
}
resetMeteors();

// Raycaster for mouse interaction
const raycaster = new THREE.Raycaster();
const mouse = new THREE.Vector2();
window.addEventListener('click', e=>{
    mouse.x = (e.clientX / window.innerWidth)*2 -1;
    mouse.y = -(e.clientY / window.innerHeight)*2 +1;
    raycaster.setFromCamera(mouse, camera);
    const intersects = raycaster.intersectObject(r2d2,true);
    if(intersects.length>0){
        r2d2.position.x += (Math.random()-0.5)*10;
        r2d2.position.z += (Math.random()-0.5)*10;
        document.getElementById('info').innerText = "R2D2 ขยับหนี!";
    }
});

// Animate
function animate(){
    requestAnimationFrame(animate);

    meteors.forEach(obj=>{
        obj.mesh.position.add(obj.velocity);
        if(r2d2 && obj.mesh.position.distanceTo(r2d2.position)<3){
            obj.velocity.x = (Math.random()-0.5)*0.5;
            obj.velocity.z = (Math.random()-0.5)*0.5;
            obj.mesh.position.y = r2d2.position.y +3;
        }
        if(obj.mesh.position.y<-10){
            obj.mesh.position.set(Math.random()*40-20,50,Math.random()*40-20);
        }
    });

    renderer.render(scene, camera);
}
animate();

// Resize
window.addEventListener('resize', ()=>{
    camera.aspect = window.innerWidth/window.innerHeight;
    camera.updateProjectionMatrix();
    renderer.setSize(window.innerWidth, window.innerHeight);
});
</script>
</body>
</html>
