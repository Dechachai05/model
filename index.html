<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="UTF-8">
<title>Scene: R2D2 + Tower + Meteors</title>
<style>
  body { margin: 0; overflow: hidden; }
  #info {
    position: absolute; top: 10px; left: 10px;
    z-index: 100; font-size: 20px;
    background: rgba(255,255,255,0.8); padding: 5px;
  }
</style>
</head>
<body>
<div id="info">Loading scene...</div>

<script src="https://cdn.jsdelivr.net/npm/three@0.128.0/build/three.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/controls/OrbitControls.js"></script>
<script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/loaders/MTLLoader.js"></script>
<script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/loaders/OBJLoader.js"></script>
<script src="https://cdn.jsdelivr.net/npm/dat.gui@0.7.9/build/dat.gui.min.js"></script>

<script>
const scene = new THREE.Scene();
const renderer = new THREE.WebGLRenderer({ antialias:true });
renderer.setSize(window.innerWidth, window.innerHeight);
renderer.shadowMap.enabled = true;
renderer.shadowMap.type = THREE.PCFSoftShadowMap;
document.body.appendChild(renderer.domElement);

// Camera & Controls
const camera = new THREE.PerspectiveCamera(75, window.innerWidth/window.innerHeight, 0.1, 1000);
camera.position.set(0, 20, 60);
const controls = new THREE.OrbitControls(camera, renderer.domElement);
controls.target.set(0,15,0);
controls.update();

// Lights
const ambient = new THREE.AmbientLight(0x808080);
scene.add(ambient);
const dirLight = new THREE.DirectionalLight(0xffffff,1);
dirLight.position.set(30,50,30);
dirLight.castShadow = true;
scene.add(dirLight);

// GUI
const gui = new dat.GUI();
const params = { numMeteors: 3, lightX:30, lightY:50, lightZ:30 };
gui.add(params,'numMeteors',1,10,1).name('Number of Meteors');
gui.add(params,'lightX',-100,100).onChange(v=>{ dirLight.position.x=v; });
gui.add(params,'lightY',0,100).onChange(v=>{ dirLight.position.y=v; });
gui.add(params,'lightZ',-100,100).onChange(v=>{ dirLight.position.z=v; });

// Ground
const groundTexture = new THREE.TextureLoader().load('https://raw.githubusercontent.com/Dechachai05/model/main/grass.jpg');
groundTexture.wrapS = groundTexture.wrapT = THREE.RepeatWrapping;
groundTexture.repeat.set(1,1);
const groundMat = new THREE.MeshStandardMaterial({ map: groundTexture, roughness:0.8, metalness:0.2 });
const groundGeo = new THREE.PlaneGeometry(50,50);
const ground = new THREE.Mesh(groundGeo, groundMat);
ground.rotation.x = -Math.PI/2;
ground.receiveShadow = true;
scene.add(ground);

// 360 background
new THREE.TextureLoader().load('https://raw.githubusercontent.com/Dechachai05/model/main/background1.jpg', tex=>{
    tex.mapping = THREE.EquirectangularReflectionMapping;
    scene.background = tex;
});

// Load R2D2 PBR
const texLoader = new THREE.TextureLoader();
const baseColorMap = texLoader.load('https://raw.githubusercontent.com/Dechachai05/model/main/SHD_R2R2_baseColor.jpeg');
const emissiveMap  = texLoader.load('https://raw.githubusercontent.com/Dechachai05/model/main/SHD_R2R2_emissive.jpeg');
const metalRoughMap = texLoader.load('https://raw.githubusercontent.com/Dechachai05/model/main/SHD_R2R2_metallicRoughness.png');
const normalMap    = texLoader.load('https://raw.githubusercontent.com/Dechachai05/model/main/SHD_R2R2_normal.png');

let r2d2 = null;
const mtlLoader = new THREE.MTLLoader();
mtlLoader.load('https://raw.githubusercontent.com/Dechachai05/model/main/r2d2.mtl', materials=>{
    materials.preload();
    const objLoader = new THREE.OBJLoader();
    objLoader.setMaterials(materials);
    objLoader.load('https://raw.githubusercontent.com/Dechachai05/model/main/r2d2.obj', obj=>{
        obj.traverse(c=>{
            if(c.isMesh){
                c.material = new THREE.MeshStandardMaterial({
                    map: baseColorMap,
                    emissiveMap: emissiveMap,
                    metalnessMap: metalRoughMap,
                    roughnessMap: metalRoughMap,
                    normalMap: normalMap,
                    metalness:1.0, roughness:1.0, emissiveIntensity:1.0
                });
                c.castShadow = true;
                c.receiveShadow = true;
            }
        });
        const bbox = new THREE.Box3().setFromObject(obj);
        const scale = 20 / Math.max(...Object.values(bbox.getSize(new THREE.Vector3())));
        obj.scale.set(scale, scale, scale);
        obj.position.y -= new THREE.Box3().setFromObject(obj).min.y;
        obj.position.x = 0; obj.position.z=0;
        r2d2 = obj;
        scene.add(obj);
        document.getElementById('info').innerText = "R2D2 loaded!";
    });
});

// Load Tower OBJ
let tower = null;
const towerBaseColor = texLoader.load('https://raw.githubusercontent.com/Dechachai05/model/main/Material.000_baseColor.jpeg');
const towerNormalMap = texLoader.load('https://raw.githubusercontent.com/Dechachai05/model/main/Material.000_normal.png');

const towerMtlLoader = new THREE.MTLLoader();
towerMtlLoader.load('https://raw.githubusercontent.com/Dechachai05/model/main/tower.mtl', materials=>{
    materials.preload();
    new THREE.OBJLoader().setMaterials(materials).load('https://raw.githubusercontent.com/Dechachai05/model/main/tower.obj', obj=>{
        obj.traverse(c=>{
            if(c.isMesh){
                c.material = new THREE.MeshStandardMaterial({
                    map: towerBaseColor,
                    normalMap: towerNormalMap,
                    metalness:0.1,
                    roughness:0.8
                });
                c.castShadow = true;
                c.receiveShadow = true;
            }
        });
        const bbox = new THREE.Box3().setFromObject(obj);
        const scale = 15 / Math.max(...Object.values(bbox.getSize(new THREE.Vector3())));
        obj.scale.set(scale, scale, scale);
        obj.position.y -= new THREE.Box3().setFromObject(obj).min.y;
        obj.position.set(15,0,10);
        tower = obj;
        scene.add(obj);
    });
});

// Add 3 buildings
const buildingGeo = new THREE.BoxGeometry(5,20,5);
const buildingMat = new THREE.MeshStandardMaterial({ color:0x888888 });
for(let i=0;i<3;i++){
    const b = new THREE.Mesh(buildingGeo, buildingMat);
    b.position.set(-20 + i*10,10,-15);
    b.castShadow = true;
    b.receiveShadow = true;
    scene.add(b);
}

// Meteors
let meteors = [];
function spawnMeteor(){
    const geo = new THREE.SphereGeometry(2,16,16);
    const mat = new THREE.MeshStandardMaterial({ color:0xff6600 });
    const meteor = new THREE.Mesh(geo, mat);
    meteor.position.set(Math.random()*40-20,50,Math.random()*40-20);
    meteor.castShadow = true;
    meteor.receiveShadow = true;
    scene.add(meteor);
    meteors.push(meteor);
}
for(let i=0;i<params.numMeteors;i++) spawnMeteor();

// Raycaster for click
const raycaster = new THREE.Raycaster();
const mouse = new THREE.Vector2();
window.addEventListener('click', e=>{
    mouse.x = (e.clientX/window.innerWidth)*2 -1;
    mouse.y = -(e.clientY/window.innerHeight)*2 +1;
    raycaster.setFromCamera(mouse,camera);
    if(r2d2){
        const intersects = raycaster.intersectObject(r2d2,true);
        if(intersects.length>0){
            r2d2.position.x += Math.random()*10 -5;
            r2d2.position.z += Math.random()*10 -5;
            document.getElementById('info').innerText = "R2D2 moved!";
        }
    }
});

// Animate
function animate(){
    requestAnimationFrame(animate);
    // Meteor movement
    meteors.forEach(m=>{
        m.position.y -= 0.5;
        if(r2d2 && m.position.distanceTo(r2d2.position)<4){
            m.position.y += 0.5; // เด้งไม่ทะลุ
            m.position.x += (Math.random()-0.5)*5; 
            m.position.z += (Math.random()-0.5)*5;
        }
        if(m.position.y<-5) m.position.set(Math.random()*40-20,50,Math.random()*40-20);
    });
    renderer.render(scene,camera);
}
animate();

// Resize
window.addEventListener('resize', ()=>{
    camera.aspect = window.innerWidth/window.innerHeight;
    camera.updateProjectionMatrix();
    renderer.setSize(window.innerWidth, window.innerHeight);
});
</script>
</body>
</html>
